version: ~> 1.0
os: linux
dist: focal
language: cpp

branches:
  only:
  - master

git:
  submodules: true

cache:
  apt: true
  ccache: true

addons:
  apt:
    sources:
      - sourceline: 'ppa:ubuntu-toolchain-r/ppa'
    packages:
      - g++-7
      - g++-8
      - g++-9
      - g++-10
      - lcov
      - cmake
arch:
  - arm64
  - s390x
  - ppc64le

env:
  - BUILD=coverage    CXX=g++-7  CC=gcc-7  BUILD_TYPE=Debug
  - BUILD=unit        CXX=g++-9  CC=gcc-9  BUILD_TYPE=Release CXXFLAGS="-std=c++2a"
  - BUILD=unit        CXX=g++-10 CC=gcc-10 BUILD_TYPE=Release CXXFLAGS="-std=c++17 -fconcepts"
  - BUILD=unit        CXX=g++-10 CC=gcc-10 BUILD_TYPE=Release
  - BUILD=unit        CXX=g++-8  CC=gcc-8  BUILD_TYPE=Release
  - BUILD=unit        CXX=g++-7  CC=gcc-7  BUILD_TYPE=Release
  - BUILD=performance CXX=g++-7  CC=gcc-7  BUILD_TYPE=Release
  - BUILD=header      CXX=g++-7  CC=gcc-7  BUILD_TYPE=Release
  - BUILD=snippet     CXX=g++-7  CC=gcc-7  BUILD_TYPE=Release

jobs:
  allow_failures:
    - os: linux
  fast_finish: true

install:
  - ccache --version
  - $CXX -v
  - cmake --version
  - |
    # use gcov7 matching the g++7 compiler
    if [[ "${BUILD}" =~ ^(coverage)$ ]]; then
      sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-7 100
    fi

before_script:
  - mkdir ../seqan3-build
  - cd ../seqan3-build
  - cmake ../seqan3/test/${BUILD} -DCMAKE_BUILD_TYPE=${BUILD_TYPE}
  - |
    if [[ "${BUILD}" =~ ^(unit|header|snippet|coverage)$ ]]; then
      make gtest_project
    fi
  - |
    if [[ "${BUILD}" =~ ^(performance)$ ]]; then
      make gbenchmark_project
    fi

script:
  - export SEQAN3_NO_VERSION_CHECK=1
  - export CCACHE_COMPRESS=true
  - export CCACHE_COMPRESSLEVEL=6
  - export CCACHE_MAXSIZE=5G
  - make -k -j2
  - |
    if [[ "${BUILD}" =~ ^(coverage)$ ]]; then
      : ; else
      if [[ "${BUILD}" =~ ^(snippet)$ ]]; then
        ctest . --output-on-failure]; else
        ctest . -j2 --output-on-failure
      fi
    fi

after_success:
  - |
    if test coverage = "${BUILD}"; then
      bash <(curl -s https://codecov.io/bash) -f ./seqan3_coverage -R "${TRAVIS_BUILD_DIR}" || echo 'Codecov failed to upload'
    fi

after_script:
  - ccache -s
